BITS 32
EXTERN _exit
EXTERN printf
GLOBAL _start
SECTION .text
_start:
	mov eax,0x8048001	;Call lookup on offset 1 byte into text (should be 0x00000292)
	call lookup
	call putmsg
	mov eax,0x804821e	;Call lookup on offset 2 bytes from the end of the text (next is invalid)
	call lookup
	call putmsg
	jmp finish
lookup:
	push edx
	mov edx,eax
	call get_eip
get_eip:
	pop eax			;mov eax,[esp+4]		;Get current instruction pointer
	sub edx,0x8048000	;Compare to start (exclusive) and set edx to an offset in the mapping
	jl failure		;Out of bounds (too small)
	cmp edx,0x220		;Compare to end (inclusive) (note we are now comparing to the size)
	jge failure		;Out of bounds (too big)
	;sub edx,0x8048000	;CAN OPTIMIZE
	mov edx,[mapping+edx*4]	;Retrieve mapping entry
	cmp edx, 0xffffffff	;Compare to invalid entry
	je failure		;It was an invalid entry
	sub eax, 0x8248		;Subtract offset from instruction pointer val to get new text base addr
	add eax,edx		;Add the offset of the destination to the new text section base addr
	pop edx
	ret
failure:
	hlt
putmsg:
	push eax		;Return value from lookup; should be offset
	push msg
	call printf
	add esp,8		;restore stack pointer
	ret
finish:
	push dword 0
	call _exit
SECTION .data
msg db "offset: 0x%x", 10, 0
;this is a mapping for mem
mapping db 0,0,0,0,146,2,0,0,6,0,0,0,7,0,0,0,8,0,0,0,152,2,0,0,10,0,0,0,154,2,0,0,12,0,0,0,156,2,0,0,14,0,0,0,158,2,0,0,16,0,0,0,160,2,0,0,18,0,0,0,162,2,0,0,20,0,0,0,164,2,0,0,22,0,0,0,166,2,0,0,24,0,0,0,168,2,0,0,26,0,0,0,170,2,0,0,28,0,0,0,172,2,0,0,184,2,0,0,195,2,0,0,186,2,0,0,203,2,0,0,188,2,0,0,205,2,0,0,36,0,0,0,221,2,0,0,38,0,0,0,223,2,0,0,40,0,0,0,211,2,0,0,42,0,0,0,213,2,0,0,44,0,0,0,230,2,0,0,46,0,0,0,232,2,0,0,48,0,0,0,49,0,0,0,239,2,0,0,51,0,0,0,241,2,0,0,53,0,0,0,243,2,0,0,55,0,0,0,251,2,0,0,57,0,0,0,1,3,0,0,59,0,0,0,3,3,0,0,10,3,0,0,62,0,0,0,12,3,0,0,64,0,0,0,20,3,0,0,66,0,0,0,45,3,0,0,68,0,0,0,24,3,0,0,70,0,0,0,53,3,0,0,72,0,0,0,28,3,0,0,74,0,0,0,30,3,0,0,76,0,0,0,32,3,0,0,78,0,0,0,34,3,0,0,80,0,0,0,60,3,0,0,78,3,0,0,62,3,0,0,80,3,0,0,85,0,0,0,65,3,0,0,87,0,0,0,67,3,0,0,89,0,0,0,69,3,0,0,91,0,0,0,71,3,0,0,87,3,0,0,94,0,0,0,89,3,0,0,96,0,0,0,97,3,0,0,98,0,0,0,109,3,0,0,100,0,0,0,117,3,0,0,102,0,0,0,129,3,0,0,104,0,0,0,131,3,0,0,106,0,0,0,133,3,0,0,108,0,0,0,135,3,0,0,110,0,0,0,137,3,0,0,112,0,0,0,145,3,0,0,114,0,0,0,147,3,0,0,116,0,0,0,149,3,0,0,118,0,0,0,151,3,0,0,120,0,0,0,153,3,0,0,122,0,0,0,155,3,0,0,124,0,0,0,157,3,0,0,126,0,0,0,159,3,0,0,128,0,0,0,161,3,0,0,186,3,0,0,199,3,0,0,188,3,0,0,165,3,0,0,134,0,0,0,206,3,0,0,136,0,0,0,169,3,0,0,138,0,0,0,171,3,0,0,140,0,0,0,173,3,0,0,142,0,0,0,175,3,0,0,144,0,0,0,213,3,0,0,222,3,0,0,215,3,0,0,224,3,0,0,149,0,0,0,226,3,0,0,151,0,0,0,228,3,0,0,153,0,0,0,230,3,0,0,155,0,0,0,232,3,0,0,233,3,0,0,158,0,0,0,241,3,0,0,160,0,0,0,161,0,0,0,162,0,0,0,249,3,0,0,164,0,0,0,165,0,0,0,166,0,0,0,1,4,0,0,168,0,0,0,12,4,0,0,25,4,0,0,14,4,0,0,27,4,0,0,173,0,0,0,37,4,0,0,175,0,0,0,39,4,0,0,177,0,0,0,45,4,0,0,179,0,0,0,47,4,0,0,181,0,0,0,49,4,0,0,183,0,0,0,51,4,0,0,185,0,0,0,53,4,0,0,187,0,0,0,55,4,0,0,56,4,0,0,190,0,0,0,64,4,0,0,192,0,0,0,193,0,0,0,194,0,0,0,72,4,0,0,196,0,0,0,197,0,0,0,198,0,0,0,80,4,0,0,200,0,0,0,91,4,0,0,104,4,0,0,93,4,0,0,106,4,0,0,205,0,0,0,116,4,0,0,207,0,0,0,118,4,0,0,209,0,0,0,124,4,0,0,211,0,0,0,126,4,0,0,133,4,0,0,214,0,0,0,135,4,0,0,216,0,0,0,143,4,0,0,218,0,0,0,145,4,0,0,220,0,0,0,147,4,0,0,222,0,0,0,149,4,0,0,224,0,0,0,151,4,0,0,163,4,0,0,176,4,0,0,165,4,0,0,178,4,0,0,230,0,0,0,190,4,0,0,232,0,0,0,198,4,0,0,234,0,0,0,200,4,0,0,236,0,0,0,208,4,0,0,238,0,0,0,210,4,0,0,240,0,0,0,218,4,0,0,242,0,0,0,220,4,0,0,244,0,0,0,228,4,0,0,246,0,0,0,230,4,0,0,248,0,0,0,249,0,0,0,233,4,0,0,251,0,0,0,239,4,0,0,253,0,0,0,245,4,0,0,252,4,0,0,0,1,0,0,1,1,0,0,2,1,0,0,4,5,0,0,4,1,0,0,5,1,0,0,6,1,0,0,12,5,0,0,8,1,0,0,23,5,0,0,44,5,0,0,25,5,0,0,46,5,0,0,13,1,0,0,56,5,0,0,15,1,0,0,58,5,0,0,31,5,0,0,18,1,0,0,33,5,0,0,20,1,0,0,35,5,0,0,22,1,0,0,37,5,0,0,24,1,0,0,25,1,0,0,26,1,0,0,65,5,0,0,91,5,0,0,67,5,0,0,68,5,0,0,97,5,0,0,107,5,0,0,33,1,0,0,113,5,0,0,114,5,0,0,74,5,0,0,120,5,0,0,80,5,0,0,131,5,0,0,40,1,0,0,137,5,0,0,144,5,0,0,43,1,0,0,146,5,0,0,153,5,0,0,46,1,0,0,155,5,0,0,48,1,0,0,163,5,0,0,50,1,0,0,165,5,0,0,52,1,0,0,167,5,0,0,54,1,0,0,169,5,0,0,56,1,0,0,57,1,0,0,58,1,0,0,59,1,0,0,177,5,0,0,61,1,0,0,179,5,0,0,180,5,0,0,64,1,0,0,65,1,0,0,186,5,0,0,67,1,0,0,68,1,0,0,193,5,0,0,194,5,0,0,205,5,0,0,212,5,0,0,197,5,0,0,214,5,0,0,75,1,0,0,76,1,0,0,77,1,0,0,255,255,255,255,79,1,0,0,80,1,0,0,225,5,0,0,82,1,0,0,227,5,0,0,84,1,0,0,229,5,0,0,86,1,0,0,231,5,0,0,88,1,0,0,233,5,0,0,90,1,0,0,235,5,0,0,92,1,0,0,237,5,0,0,94,1,0,0,239,5,0,0,96,1,0,0,241,5,0,0,98,1,0,0,243,5,0,0,100,1,0,0,245,5,0,0,102,1,0,0,247,5,0,0,104,1,0,0,249,5,0,0,106,1,0,0,251,5,0,0,108,1,0,0,253,5,0,0,110,1,0,0,255,5,0,0,112,1,0,0,1,6,0,0,114,1,0,0,3,6,0,0,116,1,0,0,5,6,0,0,118,1,0,0,7,6,0,0,120,1,0,0,9,6,0,0,122,1,0,0,11,6,0,0,124,1,0,0,13,6,0,0,126,1,0,0,15,6,0,0,128,1,0,0,17,6,0,0,130,1,0,0,19,6,0,0,132,1,0,0,21,6,0,0,134,1,0,0,23,6,0,0,136,1,0,0,25,6,0,0,26,6,0,0,42,6,0,0,140,1,0,0,50,6,0,0,142,1,0,0,61,6,0,0,148,1,0,0,33,6,0,0,67,6,0,0,75,6,0,0,76,6,0,0,153,1,0,0,87,6,0,0,159,1,0,0,100,6,0,0,165,1,0,0,166,1,0,0,167,1,0,0,168,1,0,0,169,1,0,0,170,1,0,0,171,1,0,0,108,6,0,0,173,1,0,0,116,6,0,0,175,1,0,0,118,6,0,0,177,1,0,0,120,6,0,0,179,1,0,0,122,6,0,0,181,1,0,0,124,6,0,0,183,1,0,0,126,6,0,0,185,1,0,0,128,6,0,0,187,1,0,0,130,6,0,0,189,1,0,0,132,6,0,0,191,1,0,0,134,6,0,0,193,1,0,0,136,6,0,0,195,1,0,0,138,6,0,0,197,1,0,0,151,6,0,0,141,6,0,0,166,6,0,0,175,6,0,0,168,6,0,0,177,6,0,0,204,1,0,0,179,6,0,0,206,1,0,0,181,6,0,0,208,1,0,0,183,6,0,0,210,1,0,0,185,6,0,0,212,1,0,0,193,6,0,0,214,1,0,0,215,6,0,0,216,1,0,0,217,1,0,0,198,6,0,0,219,1,0,0,200,6,0,0,221,1,0,0,202,6,0,0,223,1,0,0,204,6,0,0,225,1,0,0,222,6,0,0,231,6,0,0,224,6,0,0,247,6,0,0,230,1,0,0,249,6,0,0,236,6,0,0,3,7,0,0,13,7,0,0,20,7,0,0,0,2,0,0,22,7,0,0,2,2,0,0,24,7,0,0,4,2,0,0,26,7,0,0,36,7,0,0,45,7,0,0,38,7,0,0,61,7,0,0,30,2,0,0,69,7,0,0,50,7,0,0,71,7,0,0,52,7,0,0,35,2,0,0,54,7,0,0,255,255,255,255,255,255,255,255,78,7,0,0,40,2,0,0,110,7,0,0,121,7,0,0,131,7,0,0,138,7,0,0,45,2,0,0,140,7,0,0,68,2,0,0,142,7,0,0,70,2,0,0,148,7,0,0,76,2,0,0,77,2,0,0,151,7,0,0,160,7,0,0,168,7,0,0,182,7,0,0,82,2,0,0,171,7,0,0,88,2,0,0,193,7,0,0,94,2,0,0,203,7,0,0,96,2,0,0,221,7,0,0,98,2,0,0,232,7,0,0,208,7,0,0,234,7,0,0,210,7,0,0,103,2,0,0,212,7,0,0,241,7,0,0,249,7,0,0,128,2,0,0,129,2,0,0,130,2,0,0,131,2,0,0,132,2,0,0,0,8,0,0,134,2,0,0,2,8,0,0,255,255,255,255,255,255,255,255,8,8,0,0,139,2,0,0,10,8,0,0,255,255,255,255
